# Bedbug App Design 

## The Database 
The database schema file is in "schema.sql". There are 4 tables that are created: user, post, thread, and images. The user table stores information about the 
user (id, username and password hash). The post table stores information about the post while the images table stores information about image location and prediction results. 
We had plans to include commenting, but we removed the the functionality because would not be ready before the deadline. 

## __init__.py
This project is broken up into two main blueprints, auth and site. The __init__.py is the place where the blueprints are registered, 
as well as other config updates such as declaring the database location, and registering the CLI command `init-db`.

## Auth
`auth.py` contains all of the authentication logic. `register`, registers a user and setss registration contraints. `login` allows the user to be logged in. 
`load_logged_in_user` makes sure that a user is logged in, if they are already logged in during the session. `login_required` wraps calls that should require log ins. 
And `logout` logs out the user.  


## Site
Site contains much of the important code. 

#### index <br>
Index is the main page. In the background it calls the database and asks for all posts and all image information.
It displays the text and body of all posts (in descending order) and it also adds a thumbnail image. If there are no posts, then nothing is displayed here. It is also in index where a 
user can add new posts by clicking on "New".

#### create
Create takes users to a form where they provide information and upload a photo to classify. Behind the scenes, the image is being saved to a temporary folder. When the image is in the folder
we use a program named Pillow, to make the image a 90 by 90 thumbnail. Once the thumbnail is created, the image and the thumbnail are uploaded to a Google Cloud Bucket. Right after this, 
the image is encoded into binary and sent as a request to the model that is hosted on Google Cloud. The model returns a list of dictionaries, but thw application parses the list to get the data
that we want and returns it to the user in an understandable form. 

Several database writes happen during create. Information about the post is written to the "post" table while the image table writes the id (it is randomly generated) which is also the 
image name minus the extension. We wanted to use a simple id that is generated by the database, but we needed an image name before inserting into the database. We considered creating an insert 
(where the id is created) then grabbing the last id that was created and then giving this to the image name, but we thought that this would be apt to race conditions. With out random hex generator,
there are 36^10 possiblities, so the odds of a collision are low (we would update this in a production at to make sure no collisions happen). 

#### results
Results displays the results to the users. Once a post is clicked on, the results filters posts by the post's id number. Also each post has only one image, so it also filters out the images by the post's id. 
Having the filtered post, the page return's the post's title and the post's body. In addition, the page returns an image by taking the image name and prepends `https://storage.googleapis.com/cs50bedbugs/raw_images/"`
which points the image to the photo that is inside of the Google Cloud bucket. 


#### helper functions
The other functions are helper functions. Most of the helper functions are in helper.py, but some stayed inside of site.py. The helper functions that stayed in site.py are get_post and get_img.
Both functions do as their names say and get a post or image information (for a particular id). Their functionality is very particular, so we thought that it was best to keep it seperate from 
the main functions. 

In helper.py, we have functions that upload images (really anything) to the Google Cloud Bucket, create image thumbnails, and for sending images to the model for prediction. 


